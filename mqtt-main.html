<!doctype html>
<html lang="de">
<style>
#messages {
	background-color: yellow;
	font-size: 3;
	font-weight: bold;
	line-height: 140%;
}

#status {
	background-color: red;
	font-size: 4;
	font-weight: bold;
	color: white;
	line-height: 140%;
}

table, th, td {
	border: 2px solid black;
	border-collapse: collapse;
	padding-left: 1em;
	padding-right: 1em;
}

.nobreak {
	white-space: nowrap;
}
	
.notConnected {
  color: red; 
}
</style>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Überwachungswerte</title>
<script
	src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.js"
	type="text/javascript"></script>
<script type="text/javascript"
	src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script type="text/javascript">
	var connected_flag = 0
	var mqtt;
	var reconnectTimeout = 2000;
	var host = "192.168.178.26";
	var port = 8083;
	
	var connectAussen = 0;
	var connectInnen = 0;
	var connectGateway = 0;
	var connectGarage = 0;
	
	function updateStatus() {
		var upd = function(label, val) { 
			var el = document.getElementById(label);
			console.log("upd: (" + label + ")");
			if (val === 0) {
			  el.innerHTML = "nicht verbunden";
			  el.classlist.add("notConnected");
		    } else {
		      el.innerHTML = "verbunden";
			  el.classlist.remove("notConnected");
		    };	
		};
		console.log("upd: " + connectAussen + ", " + connectInnen + ", " + connectGateway + ", " + connectGarage);
		upd("status-innen", connectInnen);
		upd("status-Gateway", connectGateway);
		upd("status-Garage", connectGarage);
		upd("status-aussen", connectAussen);
		connectAussen = connectInnen = connectGateway = connectGarage = 0;
	}
	
	function onConnectionLost() {
		console.log("connection lost");
		document.getElementById("status").innerHTML = "Connection Lost";
		document.getElementById("messages").innerHTML = "Connection Lost";
		document.getElementById("status-mqtt").innerHTML = "Verbindung verloren";
		connected_flag = 0;
	}
	function onFailure(message) {
		console.log("Failed");
		document.getElementById("messages").innerHTML = "Connection Failed - Retrying";
		document.getElementById("status-mqtt").innerHTML = "Verbindungsfehler";
		setTimeout(MQTTconnect, reconnectTimeout);
	}
	function onMessageArrived(r_message) {
		out_msg = "Message received " + r_message.payloadString + "<br>";
		out_msg = out_msg + "Message received Topic "
				+ r_message.destinationName;
		// console.log("Message received ",r_message.payloadString);
		// console.log(out_msg);
		document.getElementById("messages").innerHTML = out_msg;
		var topic = r_message.destinationName.replaceAll("/", ":");
		if (topic.includes(":aussen:")) {
			connectAussen = 1;
		} else if (topic.includes(":innen:")) {
			connectInnen = 1;
		} else if (topic.includes(":Gateway:")) {
			connectGateway = 1; 
		} else if (topic.includes(":Garage:")) {
			connectGarage = 1;
		};
		// console.log(topic);
		var el = document.getElementById(topic);
		if (el) {
			// Dimension ergänzen
			var txt = r_message.payloadString;
			if (topic.includes("Unixzeit")){
				var zeit = new Date();
				var jetzt = new Date();
				var gestern = new Date();
				gestern.setDate(gestern.getDate() - 1);
				zeit.setTime(txt + "000");
				txt = zeit.toLocaleTimeString();
				if ((zeit.getDate() === jetzt.getDate()) && (zeit.getMonth() === jetzt.getMonth())) {
					txt += ", heute";
				} else if ((zeit.getDate() === gestern.getDate()) && (zeit.getMonth() === gestern.getMonth())) {
					txt += ", gestern";
				} else {
				    txt += " am " + zeit.toLocaleDateString();
				};
			} else if (topic.toUpperCase().includes("TEMPERATUR")) {
				txt += "°C";
			} else if (topic.includes("Luftfeuchte")) {
				txt += " %";
			} else if (topic.includes("Luftdruck")) {
				txt += " hPa";
			} else if (topic.includes("Lichtwert")) {
				txt += " lux";
			} else if (topic.includes("magnet")) {
				txt = (txt === "1" ? "geschlossen" : "geöffnet");
			};
			el.innerHTML = txt;
		} else {
			if (topic.includes("bwrest")) {
				var txt = r_message.payloadString;
				var status = "aktiv, noch "
				txt.split("/").forEach(function(val, i, arr){
					var el = document.getElementById("Kreis" + i);
					el.innerHTML = (val === "0" ? "aus" : status + val + " Minuten");
					if (val !== "0") {status = "wartet, insgesamt ";};
				});
			};
		};
		
	}
	function onConnected(recon, url) {
		console.log(" in onConnected " + reconn);
	}
	function onConnect() {
		// Once a connection has been made, make a subscription and send a message.
		document.getElementById("messages").innerHTML = "Connected to " + host
				+ "on port " + port;
		connected_flag = 1
		document.getElementById("status").innerHTML = "Connected";
		console.log("on Connect " + connected_flag);
		mqtt.subscribe("/ArbeitszimmerK/#");
		mqtt.subscribe("/Garage/#");
		document.getElementById("status-mqtt").innerHTML = "Verbindung aktiv";
	}

	function MQTTconnect() {

		console.log("connecting to " + host + " " + port);
		var x = Math.floor(Math.random() * 10000);
		var cname = "controlform-" + x;
		mqtt = new Paho.MQTT.Client(host, port, cname);
		console.log("connecting " + cname + " to "+ host);
		var options = {
			timeout : 3,
			onSuccess : onConnect,
			onFailure : onFailure,

		};

		mqtt.onConnectionLost = onConnectionLost;
		mqtt.onMessageArrived = onMessageArrived;
		//mqtt.onConnected = onConnected;

		mqtt.connect(options);
		return false;

	}
	
	function sub_topics() {
		document.getElementById("messages").innerHTML = "";
		if (connected_flag == 0) {
			out_msg = "<b>Not Connected so can't subscribe</b>"
			console.log(out_msg);
			document.getElementById("messages").innerHTML = out_msg;
			return false;
		}
		var stopic = document.forms["subs"]["Stopic"].value;
		console.log("Subscribing to topic =" + stopic);
		mqtt.subscribe(stopic);
		return false;
	}
	
	function send_message(msg, topic) {
		if (connected_flag == 0) {
			out_msg = "<b>Not Connected so can't send</b>"
			console.log(out_msg);
			document.getElementById("messages").innerHTML = out_msg;
			return false;
		}
		var value = msg.value;
		console.log("value= " + value);
		console.log("topic= " + topic);
		message = new Paho.MQTT.Message(value);
		message.destinationName = "house/" + topic;

		mqtt.send(message);
		return false;
	}
</script>
</head>
<body onload="MQTTconnect(); window.setInterval(updateStatus, 7000);">
	<h2>Überwachungswerte</h2>
	<table>
	    <tr> <th></th> 
	       <th width="200px"> Temperatur </th>	 
	                   <th> Luftfeuchtigkeit </th>
	    	                              <th> Luftdruck </th>	
	    	                                           <th> Lichtwert </th>    	 
	    </tr>
	    <tr><th>außen</th>
	    <td id=":ArbeitszimmerK:aussen:TemperaturInfo:Ausgelesen"></td>
	    <td id=":ArbeitszimmerK:aussen:LuftfeuchteInfo:Ausgelesen"></td>
	    <td id=":ArbeitszimmerK:aussen:LuftdruckInfo:Ausgelesen"></td>
	    <td id=":ArbeitszimmerK:aussen:LichtwertInfo:Ausgelesen"></td>
	    </tr>
	    <tr><th>außen max </th>
	    <td> <span class="nobreak">
	           <span id=":ArbeitszimmerK:aussen:TemperaturInfo:Maximum"> </span> um 
	           <span id=":ArbeitszimmerK:aussen:TemperaturInfo:MaximumUnixzeit">
	         </span></span></td>
	    <td><span class="nobreak">
	           <span id=":ArbeitszimmerK:aussen:LuftfeuchteInfo:Maximum"></span> um 
	           <span id=":ArbeitszimmerK:aussen:LuftfeuchteInfo:MaximumUnixzeit"></span>
	         </span>  </td>
	    <td> <span class="nobreak">
	           <span id=":ArbeitszimmerK:aussen:LuftdruckInfo:Maximum"></span> um
	           <span id=":ArbeitszimmerK:aussen:LuftdruckInfo:MaximumUnixzeit"></span>
	         </span></td>
	    <td> <span class="nobreak">
	           <span id=":ArbeitszimmerK:aussen:LichtwertInfo:Maximum"></span> um 
	           <span id=":ArbeitszimmerK:aussen:LichtwertInfo:MaximumUnixzeit"></span>
	           </span></td>
	    </tr>
	    <tr><th>außen min </th>
	    <td> <span class="nobreak">
	           <span id=":ArbeitszimmerK:aussen:TemperaturInfo:Minimum"> </span> um 
	           <span id=":ArbeitszimmerK:aussen:TemperaturInfo:MinimumUnixzeit">
	         </span></span></td>
	    <td><span class="nobreak">
	           <span id=":ArbeitszimmerK:aussen:LuftfeuchteInfo:Minimum"></span> um 
	           <span id=":ArbeitszimmerK:aussen:LuftfeuchteInfo:MinimumUnixzeit"></span>
	         </span>  </td>
	    <td> <span class="nobreak">
	           <span id=":ArbeitszimmerK:aussen:LuftdruckInfo:Minimum"></span> um
	           <span id=":ArbeitszimmerK:aussen:LuftdruckInfo:MinimumUnixzeit"></span>
	         </span></td>
	    <td> <span class="nobreak">
	           <span id=":ArbeitszimmerK:aussen:LichtwertInfo:Minimum"></span> um 
	           <span id=":ArbeitszimmerK:aussen:LichtwertInfo:MinimumUnixzeit"></span>
	           </span></td>
	    </tr>
	    <tr><th>innen</th>
	    <td id=":ArbeitszimmerK:innen:Temperatur2Info:Ausgelesen"></td>
	    <td id=":ArbeitszimmerK:innen:Luftfeuchte2Info:Ausgelesen"></td>
	    <td id=":ArbeitszimmerK:innen:LuftdruckInfo:Ausgelesen"></td>
	    <td id=":ArbeitszimmerK:innen:LichtwertInfo:Ausgelesen"></td>
	    </tr>
	    <tr><th>innen max </th>
	    <td> <span class="nobreak">
	           <span id=":ArbeitszimmerK:innen:Temperatur2Info:Maximum"> </span> um 
	           <span id=":ArbeitszimmerK:innen:Temperatur2Info:MaximumUnixzeit">
	         </span></span></td>
	    <td><span class="nobreak">
	           <span id=":ArbeitszimmerK:innen:Luftfeuchte2Info:Maximum"></span> um 
	           <span id=":ArbeitszimmerK:innen:Luftfeuchte2Info:MaximumUnixzeit"></span>
	         </span>  </td>
	    <td> </td>
	    <td> </td>
	    </tr>
	    <tr><th>innen min </th>
	    <td> <span class="nobreak">
	           <span id=":ArbeitszimmerK:innen:Temperatur2Info:Minimum"> </span> um 
	           <span id=":ArbeitszimmerK:innen:Temperatur2Info:MinimumUnixzeit">
	         </span></span></td>
	    <td><span class="nobreak">
	           <span id=":ArbeitszimmerK:innen:Luftfeuchte2Info:Minimum"></span> um 
	           <span id=":ArbeitszimmerK:innen:Luftfeuchte2Info:MinimumUnixzeit"></span>
	         </span>  </td>
	    <td> </td>
	    <td> </td>
	    </tr>
	    <tr><th>Garage</th>
	    <td id=":Garage:in:temperatur"></td>
	    <td></td>
	    <td></td>
	    <td></td>
	    </tr>
	</table>
	<p></p>
	<h2>Garage</h2>
	<table>
	<tr><th>Tor</th><td><span id =":Garage:in:magnet"></span></td></tr>
	<tr><th>Bewässerung Kreis 1</th><td><span id ="Kreis0">keine Information</span></td></tr>
	<tr><th>Bewässerung Kreis 2</th><td><span id ="Kreis1">keine Information</span></td></tr>
	<tr><th>Bewässerung Kreis 3</th><td><span id ="Kreis2">keine Information</span></td></tr>
	<tr><th>Bewässerung Kreis 4</th><td><span id ="Kreis3">keine Information</span></td></tr>
	</table>
	
	<h2>Status</h2>
	<table>
	  <tr><th>MQTT</th><td><span id="status-mqtt">keine Information</span></td></tr>
	  <tr><th>Überwachung aussen</th><td><span id="status-aussen">keine Information</span></td></tr>
	  <tr><th>Überwachung innen</th><td><span id="status-innen">keine Information</span></td></tr>
	  <tr><th>Gateway WLAN/LoRa</th><td><span id="status-Gateway">keine Information</span></td></tr>
	  <tr><th>LoRa Garage</th><td><span id="status-Garage">keine Information</span></td></tr>
	</table>
	
	<p></p>
	<div id="status">Connection Status: Not Connected
	</div>



	<hr>


	Messages:
	<p id="messages"></p>

</body>
</html>
